repos:
  # Terraform hooks
  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.96.1
    hooks:
      # Format Terraform files (pre-commit only - fast feedback)
      - id: terraform_fmt
        name: Terraform fmt
        description: Rewrites all Terraform configuration files to canonical format
        stages: [pre-commit]

      # Validate Terraform files (pre-push only - comprehensive check)
      - id: terraform_validate
        name: Terraform validate
        description: Validates all Terraform configuration files
        stages: [pre-push]
        args:
          - --hook-config=--retry-once-with-cleanup=true

      # Generate and update documentation (pre-commit only)
      - id: terraform_docs
        name: Terraform docs
        description: Inserts input and output documentation into README.md
        stages: [pre-commit]
        args:
          - --hook-config=--path-to-file=README.md
          - --hook-config=--add-to-existing-file=true
          - --hook-config=--create-file-if-not-exist=true

      # Lint Terraform files with tflint (pre-push only - slower check)
      - id: terraform_tflint
        name: TFLint
        description: Linter for Terraform files with custom rules
        stages: [pre-push]
        args:
          - --args=--config=__GIT_WORKING_DIR__/.tflint.hcl

      # Security scanning with tfsec (pre-push only - comprehensive security)
      - id: terraform_tfsec
        name: TFSec
        description: Security scanner with enhanced policies
        stages: [pre-push]
        args:
          - --args=--minimum-severity=LOW
          - --args=--config-file=__GIT_WORKING_DIR__/.tfsec.yml

  # General file checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      # Prevent large files from being committed (pre-commit - fast)
      - id: check-added-large-files
        name: Check for large files
        stages: [pre-commit]
        args: ['--maxkb=1000']

      # Check for merge conflicts (pre-commit - fast)
      - id: check-merge-conflict
        name: Check for merge conflicts
        stages: [pre-commit]

      # Check YAML files (pre-commit - fast)
      - id: check-yaml
        name: Check YAML syntax
        stages: [pre-commit]

      # Check TOML files (pre-commit - fast)
      - id: check-toml
        name: Check TOML syntax
        stages: [pre-commit]

      # Check for trailing whitespace (pre-commit - fast)
      - id: trailing-whitespace
        name: Trim trailing whitespace
        stages: [pre-commit]
        args: ['--markdown-linebreak-ext=md']

      # Ensure files end with newline (pre-commit - fast)
      - id: end-of-file-fixer
        name: Fix end of files
        stages: [pre-commit]

      # Check for private keys (pre-push - security critical)
      - id: detect-private-key
        name: Detect private keys
        stages: [pre-push]

      # Check for AWS credentials (pre-push - security critical)
      - id: detect-aws-credentials
        name: Detect AWS credentials
        stages: [pre-push]
        args: ['--allow-missing-credentials']

  # TOML formatting and linting
  - repo: https://github.com/ComPWA/taplo-pre-commit
    rev: v0.9.3
    hooks:
      # Format TOML files (pre-commit - fast)
      - id: taplo-format
        name: Format TOML files
        description: Auto-format TOML files with taplo
        stages: [pre-commit]

      # Lint TOML files (pre-commit - fast)
      - id: taplo-lint
        name: Lint TOML files
        description: Lint TOML files for errors and style issues
        stages: [pre-commit]

  # Markdown linting (using mise-installed markdownlint-cli2)
  - repo: local
    hooks:
      # Markdown linting (pre-commit - fast)
      - id: markdownlint
        name: Markdown lint
        description: Lint and fix markdown files
        entry: markdownlint-cli2
        args: ['--fix', '--config', '.markdownlint.yaml']
        language: system
        types: [markdown]
        stages: [pre-commit]
        exclude: '(\.terraform/|node_modules/)'

      # Custom validation: Check tfvars.example coverage (pre-push - validation)
      - id: check-tfvars-coverage
        name: Verify tfvars.example coverage
        description: Ensure all variables are documented in terraform.tfvars.example
        entry: ./scripts/check-tfvars-coverage.sh
        language: script
        files: '(variables\.tf|terraform\.tfvars\.example)$'
        stages: [pre-push]
        pass_filenames: false

      # OPA/Conftest policy validation (pre-push - comprehensive policy check)
      - id: conftest-policy-check
        name: Conftest policy validation
        description: Validate Terraform modules with custom OPA policies
        entry: bash -c 'conftest test --policy policy/ modules/ --all-namespaces || true'
        language: system
        files: '\.tf$'
        stages: [pre-push]
        exclude: '(\.terraform/|examples/)'
        pass_filenames: false
