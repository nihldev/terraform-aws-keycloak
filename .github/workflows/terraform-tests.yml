name: Terraform Tests

on:
  pull_request:
    paths:
      - "modules/keycloak/**"
      - "examples/**"
      - "tests/**"
      - "scripts/**"
      - "policy/**"
      - ".github/workflows/terraform-tests.yml"
      - ".pre-commit-config.yaml"
      - ".tflint.hcl"
      - ".trivyignore"
  push:
    paths:
      - "modules/keycloak/**"
      - "examples/**"
      - "tests/**"
      - "scripts/**"
      - "policy/**"
      - ".github/workflows/terraform-tests.yml"
  workflow_dispatch: # Allow manual trigger

# Prevent duplicate workflow runs
# Groups by PR number for pull_request events, or by branch name for push events
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  TERRAFORM_VERSION: "1.14.0"
  TFLINT_VERSION: "v0.54.0"
  PYTHON_VERSION: "3.11"

jobs:
  #######################
  # Format and Lint Checks
  #######################
  format-and-lint:
    name: Format & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Node.js (for markdownlint)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install linting tools
        run: |
          npm install -g markdownlint-cli2 prettier
          pip install yamllint ruff basedpyright

      - name: Install additional tools
        run: |
          # Install shellcheck
          sudo apt-get update && sudo apt-get install -y shellcheck
          # Install taplo for TOML linting
          curl -fsSL https://github.com/tamasfe/taplo/releases/latest/download/taplo-linux-x86_64.gz | gunzip > /usr/local/bin/taplo
          chmod +x /usr/local/bin/taplo
          # Install gitleaks for secret detection
          curl -fsSL https://github.com/gitleaks/gitleaks/releases/download/v8.21.2/gitleaks_8.21.2_linux_x64.tar.gz | tar xz -C /usr/local/bin gitleaks
          # Install terraform-docs
          curl -fsSL https://github.com/terraform-docs/terraform-docs/releases/download/v0.19.0/terraform-docs-v0.19.0-linux-amd64.tar.gz | tar xz -C /usr/local/bin terraform-docs
          # Install conftest for OPA policy testing
          curl -fsSL https://github.com/open-policy-agent/conftest/releases/download/v0.56.0/conftest_0.56.0_Linux_x86_64.tar.gz | tar xz -C /usr/local/bin conftest

      # Terraform formatting
      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      # GitHub Actions workflow linting
      - name: Setup actionlint
        uses: raven-actions/actionlint@v2
        with:
          matcher: true

      - name: Run actionlint
        run: actionlint -color

      # YAML linting
      - name: YAML Lint
        run: |
          yamllint -d relaxed .github/workflows/*.yml

      # Check GitHub workflow formatting with prettier
      - name: Check workflow formatting
        run: |
          prettier --check '.github/workflows/*.yml'

      # Markdown linting
      - name: Markdown Lint
        run: |
          markdownlint-cli2 "**/*.md" --config .markdownlint.yaml

      # Python linting and formatting
      - name: Python Lint (Ruff)
        run: |
          ruff check .
          ruff format --check .

      # Python type checking
      - name: Python Type Check (Basedpyright)
        run: basedpyright

      # Shell script linting
      - name: Shellcheck
        run: |
          shellcheck scripts/*.sh

      # TOML linting
      - name: TOML Lint (Taplo)
        run: |
          taplo lint
          taplo fmt --check

      # Secret detection
      - name: Secret Detection (Gitleaks)
        run: |
          gitleaks git --redact --verbose

      # Terraform docs validation
      - name: Terraform Docs Check
        run: |
          terraform-docs markdown table --output-file README.md --output-mode inject modules/keycloak
          if ! git diff --quiet README.md; then
            echo "Error: README.md is out of date. Run 'terraform-docs markdown table --output-file README.md --output-mode inject modules/keycloak'"
            git diff README.md
            exit 1
          fi

      # Check tfvars.example coverage
      - name: Check tfvars.example Coverage
        run: |
          ./scripts/check-tfvars-coverage.sh

      # Check for trailing whitespace and file endings
      - name: Check file formatting
        run: |
          # Check for trailing whitespace (excluding markdown)
          if git grep -l '[[:blank:]]$' -- '*.tf' '*.py' '*.sh' '*.yml' '*.yaml' 2>/dev/null; then
            echo "Error: trailing whitespace found"
            exit 1
          fi
          # Check files end with newline
          for f in $(find . -name "*.tf" -o -name "*.py" -o -name "*.sh" | head -20); do
            if [ -n "$(tail -c 1 "$f")" ]; then
              echo "Error: $f does not end with newline"
              exit 1
            fi
          done
          echo "All file formatting checks passed"

  #######################
  # Terraform Validation
  #######################
  validation:
    name: Terraform Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Python (for SES SMTP script)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Validate main module
      - name: Terraform Init (Module)
        working-directory: modules/keycloak
        run: terraform init -backend=false

      - name: Terraform Validate (Module)
        working-directory: modules/keycloak
        run: terraform validate

      # Validate all examples
      - name: Validate Examples
        run: |
          for example in examples/*/; do
            echo "=== Validating $example ==="
            cd "$example"
            terraform init -backend=false
            terraform validate
            cd ../..
          done

  #######################
  # Security Scanning
  #######################
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: validation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "config"
          scan-ref: "modules/keycloak"
          trivyignores: ".trivyignore"
          exit-code: "1"
          severity: "HIGH,CRITICAL"

      # TFLint linter
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Init TFLint
        working-directory: modules/keycloak
        run: tflint --init --config=../../.tflint.hcl

      - name: Run TFLint
        working-directory: modules/keycloak
        run: tflint -f compact --config=../../.tflint.hcl

      # OPA/Conftest policy validation
      - name: Install Conftest
        run: |
          curl -fsSL https://github.com/open-policy-agent/conftest/releases/download/v0.56.0/conftest_0.56.0_Linux_x86_64.tar.gz | tar xz -C /usr/local/bin conftest

      - name: Run Conftest Policy Checks
        run: |
          conftest test --policy policy/ modules/ --all-namespaces

  #######################
  # Plan-Only Tests
  #######################
  plan-tests:
    name: Plan Tests
    runs-on: ubuntu-latest
    needs: [validation, security-scan]

    strategy:
      fail-fast: false
      matrix:
        test:
          - module_validation
          - variable_combinations
          - aurora_database
          - ses_email

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Python (for SES SMTP script)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          # Use OIDC for better security (recommended)
          # role-to-assume: ${{ secrets.AWS_TEST_ROLE_ARN }}
          # Or use access keys
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Run Test - ${{ matrix.test }}
        run: |
          set -o pipefail
          # Non-verbose output for cleaner logs; run locally with -verbose to debug failures
          terraform test tests/${{ matrix.test }}.tftest.hcl 2>&1 | head -500
        timeout-minutes: 20

  #######################
  # Output Validation Tests
  #######################
  output-tests:
    name: Output Validation
    runs-on: ubuntu-latest
    needs: [validation, security-scan]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Python (for SES SMTP script)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Run Output Validation Tests
        run: |
          set -o pipefail
          # Non-verbose output for cleaner logs; run locally with -verbose to debug failures
          terraform test tests/outputs_validation.tftest.hcl 2>&1 | head -500
        timeout-minutes: 30

  #######################
  # Example Validation Tests
  #######################
  example-tests:
    name: Example Tests
    runs-on: ubuntu-latest
    needs: [validation, security-scan]

    strategy:
      fail-fast: false
      matrix:
        example:
          - examples_basic
          - examples_complete

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Python (for SES SMTP script)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Run Test - ${{ matrix.example }}
        run: |
          set -o pipefail
          # Non-verbose output for cleaner logs; run locally with -verbose to debug failures
          terraform test tests/${{ matrix.example }}.tftest.hcl 2>&1 | head -500
        timeout-minutes: 20

  #######################
  # Status Check (Final Gate)
  #######################
  status-check:
    name: Status Check
    runs-on: ubuntu-latest
    needs:
      - format-and-lint
      - validation
      - security-scan
      - plan-tests
      - output-tests
      - example-tests
    if: always()

    steps:
      - name: Check Results
        run: |
          echo "=== Job Results ==="
          echo "format-and-lint: ${{ needs.format-and-lint.result }}"
          echo "validation: ${{ needs.validation.result }}"
          echo "security-scan: ${{ needs.security-scan.result }}"
          echo "plan-tests: ${{ needs.plan-tests.result }}"
          echo "output-tests: ${{ needs.output-tests.result }}"
          echo "example-tests: ${{ needs.example-tests.result }}"
          echo ""

          # Check critical jobs (must pass)
          if [ "${{ needs.format-and-lint.result }}" != "success" ] || \
             [ "${{ needs.validation.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "❌ Critical checks failed"
            exit 1
          fi

          # Check test jobs (report but don't fail on skipped)
          if [ "${{ needs.plan-tests.result }}" == "failure" ] || \
             [ "${{ needs.output-tests.result }}" == "failure" ] || \
             [ "${{ needs.example-tests.result }}" == "failure" ]; then
            echo "❌ One or more test jobs failed"
            exit 1
          fi

          echo "✅ All checks passed!"
