name: Terraform Tests

on:
  pull_request:
    paths:
      - "modules/keycloak/**"
      - "examples/**"
      - "tests/**"
      - "scripts/**"
      - "policy/**"
      - ".github/workflows/terraform-tests.yml"
      - ".pre-commit-config.yaml"
      - ".tflint.hcl"
      - ".tfsec.yml"
  push:
    paths:
      - "modules/keycloak/**"
      - "examples/**"
      - "tests/**"
      - "scripts/**"
      - "policy/**"
      - ".github/workflows/terraform-tests.yml"
  workflow_dispatch: # Allow manual trigger

env:
  TERRAFORM_VERSION: "1.14.0"
  TFLINT_VERSION: "v0.54.0"
  PYTHON_VERSION: "3.11"

jobs:
  #######################
  # Format and Lint Checks
  #######################
  format-and-lint:
    name: Format & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Node.js (for markdownlint)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install linting tools
        run: |
          npm install -g markdownlint-cli2
          pip install yamllint

      # Terraform formatting
      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      # YAML linting
      - name: YAML Lint
        run: |
          yamllint -d relaxed .github/workflows/*.yml || true

      # Markdown linting
      - name: Markdown Lint
        run: |
          markdownlint-cli2 "**/*.md" --config .markdownlint.yaml || true

      # Check for trailing whitespace and file endings
      - name: Check file formatting
        run: |
          # Check for trailing whitespace (excluding markdown)
          ! git grep -l '[[:blank:]]$' -- '*.tf' '*.py' '*.sh' '*.yml' '*.yaml' || echo "Warning: trailing whitespace found"
          # Check files end with newline
          for f in $(find . -name "*.tf" -o -name "*.py" -o -name "*.sh" | head -20); do
            if [ -n "$(tail -c 1 "$f")" ]; then
              echo "Warning: $f does not end with newline"
            fi
          done

  #######################
  # Terraform Validation
  #######################
  validation:
    name: Terraform Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Python (for SES SMTP script)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Validate main module
      - name: Terraform Init (Module)
        working-directory: modules/keycloak
        run: terraform init -backend=false

      - name: Terraform Validate (Module)
        working-directory: modules/keycloak
        run: terraform validate

      # Validate all examples
      - name: Validate Examples
        run: |
          for example in examples/*/; do
            echo "=== Validating $example ==="
            cd "$example"
            terraform init -backend=false
            terraform validate
            cd ../..
          done

  #######################
  # Security Scanning
  #######################
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: validation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      # TFSec security scanner
      - name: Run TFSec
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          working_directory: modules/keycloak
          soft_fail: false

      # TFLint linter
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Init TFLint
        working-directory: modules/keycloak
        run: tflint --init --config=../../.tflint.hcl

      - name: Run TFLint
        working-directory: modules/keycloak
        run: tflint -f compact --config=../../.tflint.hcl

  #######################
  # Plan-Only Tests
  #######################
  plan-tests:
    name: Plan Tests
    runs-on: ubuntu-latest
    needs: [validation, security-scan]

    strategy:
      fail-fast: false
      matrix:
        test:
          - module_validation
          - variable_combinations
          - aurora_database
          - ses_email

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Python (for SES SMTP script)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          # Use OIDC for better security (recommended)
          # role-to-assume: ${{ secrets.AWS_TEST_ROLE_ARN }}
          # Or use access keys
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Run Test - ${{ matrix.test }}
        run: |
          # Run only plan-based tests (filter out apply tests)
          terraform test tests/${{ matrix.test }}.tftest.hcl -verbose 2>&1 | head -500 || true
        timeout-minutes: 15

  #######################
  # Output Validation Tests
  #######################
  output-tests:
    name: Output Validation
    runs-on: ubuntu-latest
    needs: [validation, security-scan]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Python (for SES SMTP script)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Run Output Validation Tests
        run: |
          terraform test tests/outputs_validation.tftest.hcl -verbose 2>&1 | head -500 || true
        timeout-minutes: 30

  #######################
  # Example Validation Tests
  #######################
  example-tests:
    name: Example Tests
    runs-on: ubuntu-latest
    needs: [validation, security-scan]

    strategy:
      fail-fast: false
      matrix:
        example:
          - examples_basic
          - examples_complete

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Python (for SES SMTP script)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Run Test - ${{ matrix.example }}
        run: |
          terraform test tests/${{ matrix.example }}.tftest.hcl -verbose 2>&1 | head -500 || true
        timeout-minutes: 15

  #######################
  # Status Check (Final Gate)
  #######################
  status-check:
    name: Status Check
    runs-on: ubuntu-latest
    needs:
      - format-and-lint
      - validation
      - security-scan
      - plan-tests
      - output-tests
      - example-tests
    if: always()

    steps:
      - name: Check Results
        run: |
          echo "=== Job Results ==="
          echo "format-and-lint: ${{ needs.format-and-lint.result }}"
          echo "validation: ${{ needs.validation.result }}"
          echo "security-scan: ${{ needs.security-scan.result }}"
          echo "plan-tests: ${{ needs.plan-tests.result }}"
          echo "output-tests: ${{ needs.output-tests.result }}"
          echo "example-tests: ${{ needs.example-tests.result }}"
          echo ""

          # Check critical jobs (must pass)
          if [ "${{ needs.format-and-lint.result }}" != "success" ] || \
             [ "${{ needs.validation.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "❌ Critical checks failed"
            exit 1
          fi

          # Check test jobs (report but don't fail on skipped)
          if [ "${{ needs.plan-tests.result }}" == "failure" ] || \
             [ "${{ needs.output-tests.result }}" == "failure" ] || \
             [ "${{ needs.example-tests.result }}" == "failure" ]; then
            echo "❌ One or more test jobs failed"
            exit 1
          fi

          echo "✅ All checks passed!"
